# ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (Troubleshooting Guide)

## ‡πÄ‡∏Ñ‡∏™: User Role ‡πÅ‡∏•‡∏∞ Dashboard Display ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
- User ‡∏°‡∏µ `full_name` ‡πÄ‡∏õ‡πá‡∏ô "Requester" ‡πÅ‡∏ï‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏™‡∏î‡∏á AdminDashboard
- ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô RequesterDashboard ‡∏ï‡∏≤‡∏° full_name
- ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏ö‡∏™‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á role ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô UI

### ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Ç‡∏≠‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤
1. **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô**: Role ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô `fa_admin` ‡πÅ‡∏ï‡πà `full_name` ‡πÄ‡∏õ‡πá‡∏ô "Requester"
2. **‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á**: ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏° role ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏≤‡∏° full_name
3. **‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á**: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤ full_name ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏≥‡∏´‡∏ô‡∏î dashboard

### ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£ Debug
1. **‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console Logs**
   ```javascript
   console.log('Dashboard - User role:', user.role, 'User data:', user);
   ```

2. **Query ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô**
   ```sql
   SELECT id, full_name, email, role FROM profiles WHERE id = 'user-id';
   ```

3. **‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á Dashboard Router**
   ```javascript
   switch (user.role) {
     case 'fa_admin':
       return <AdminDashboard />;
     case 'requester':
       return <RequesterDashboard />;
     // ...
   }
   ```

### ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

#### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤
```sql
-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• user ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
SELECT id, full_name, email, role, is_active 
FROM profiles 
WHERE full_name LIKE '%Requester%' OR role != 'requester';
```

#### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
```sql
-- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç role ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
UPDATE public.profiles 
SET role = 'requester' 
WHERE id = 'user-id' 
  AND full_name = 'Requester';
```

#### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö RLS Policies
```sql
-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á RLS policies
DROP POLICY IF EXISTS "Users can view their own requests" ON public.requests;

CREATE POLICY "Requesters can view only their own requests"
ON public.requests 
FOR SELECT 
USING (requester_id = auth.uid());
```

### ‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï

#### 1. Data Consistency Validation
- ‡∏™‡∏£‡πâ‡∏≤‡∏á validation ‡πÉ‡∏´‡πâ full_name ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö role
- ‡πÉ‡∏ä‡πâ trigger ‡∏´‡∏£‡∏∑‡∏≠ function ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

#### 2. Clear Naming Convention
```sql
-- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á naming convention ‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
UPDATE profiles SET 
  full_name = CASE 
    WHEN role = 'fa_admin' THEN 'Admin: ' || full_name
    WHEN role = 'requester' THEN 'Requester: ' || full_name
    WHEN role = 'receiver' THEN 'Receiver: ' || full_name
  END;
```

#### 3. Enhanced Debugging
```javascript
// ‡πÄ‡∏û‡∏¥‡πà‡∏° debug information ‡πÉ‡∏ô Dashboard component
const Dashboard = () => {
  const { user, loading } = useAuth();
  
  // Debug logging
  useEffect(() => {
    if (user) {
      console.log('üîç Dashboard Debug:', {
        userId: user.id,
        role: user.role,
        fullName: user.full_name,
        email: user.email
      });
    }
  }, [user]);
  
  // ... rest of component
};
```

#### 4. Role-based Access Control (RBAC) Best Practices
```javascript
// ‡∏™‡∏£‡πâ‡∏≤‡∏á utility function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö role
export const hasRole = (user: User, requiredRole: string): boolean => {
  return user?.role === requiredRole;
};

export const canAccessAdminFeatures = (user: User): boolean => {
  return hasRole(user, 'fa_admin');
};
```

### Test Cases ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

#### Test 1: Admin User
```javascript
// Expected: Admin user ‡πÄ‡∏´‡πá‡∏ô AdminDashboard
const adminUser = { role: 'fa_admin', full_name: 'Admin User' };
// Should render: <AdminDashboard />
```

#### Test 2: Requester User  
```javascript
// Expected: Requester user ‡πÄ‡∏´‡πá‡∏ô RequesterDashboard
const requesterUser = { role: 'requester', full_name: 'Requester User' };
// Should render: <RequesterDashboard />
```

#### Test 3: Data Access Rights
```sql
-- Test: Requester ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
-- Test: Admin ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
```

---

## ‡πÄ‡∏Ñ‡∏™‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢

### ‡πÄ‡∏Ñ‡∏™: RLS Policy ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
**‡∏õ‡∏±‡∏ç‡∏´‡∏≤**: User ‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç**:
1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö auth.uid() ‡πÉ‡∏ô RLS policy
2. ‡πÉ‡∏ä‡πâ security definer function ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á infinite recursion
3. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö policy ‡∏î‡πâ‡∏ß‡∏¢ different user roles

### ‡πÄ‡∏Ñ‡∏™: Dashboard Loading ‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à
**‡∏õ‡∏±‡∏ç‡∏´‡∏≤**: Dashboard ‡πÅ‡∏™‡∏î‡∏á loading state ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç**:
1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö useAuth hook
2. ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô user object structure
3. ‡πÄ‡∏ä‡πá‡∏Ñ network requests ‡πÉ‡∏ô browser dev tools

---

## Checklist ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤

- [ ] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö console logs
- [ ] ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
- [ ] ‡∏ó‡∏î‡∏™‡∏≠‡∏ö RLS policies
- [ ] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö user authentication state
- [ ] ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô component rendering logic
- [ ] ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö different user roles
- [ ] ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó documentation

---

## ‡πÄ‡∏Ñ‡∏™: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏°‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
- Admin ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß
- ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
- ‡πÅ‡∏ï‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏õ‡πá‡∏ô "‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß"
- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏õ‡πá‡∏ô status: "pending"

### ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Ç‡∏≠‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤
1. **RLS (Row Level Security) Policy** ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
2. ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ `supabase.from('requests').update()` ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ú‡πà‡∏≤‡∏ô RLS policy ‡πÑ‡∏î‡πâ
3. User ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡∏≤‡∏° policy ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ

### ‡∏Å‡∏≤‡∏£ Debug ‡∏õ‡∏±‡∏ç‡∏´‡∏≤

#### 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console Logs
```javascript
console.log('Approving request:', request.id);
console.log('User:', user);
console.log('Update data:', updateData);
console.log('Update result:', updateResult);
```

#### 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
```sql
SELECT * FROM requests WHERE id = 'request-id';
```

#### 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö RLS Policies
```sql
SELECT * FROM pg_policies WHERE tablename = 'requests';
```

### ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏™‡∏£‡πâ‡∏≤‡∏á Database Function ‡πÅ‡∏ö‡∏ö SECURITY DEFINER

#### Step 1: ‡∏™‡∏£‡πâ‡∏≤‡∏á Function ‡πÉ‡∏ô Supabase
```sql
CREATE OR REPLACE FUNCTION public.approve_request(
  p_request_id uuid,
  p_tracking_number text,
  p_admin_id uuid
)
RETURNS json
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  admin_role text;
  updated_request record;
BEGIN
  -- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô fa_admin ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  SELECT role INTO admin_role 
  FROM public.profiles 
  WHERE id = p_admin_id AND is_active = true;
  
  -- ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà fa_admin ‡πÉ‡∏´‡πâ throw error
  IF admin_role != 'fa_admin' THEN
    RAISE EXCEPTION '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠';
  END IF;
  
  -- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏≥‡∏Ç‡∏≠
  UPDATE public.requests 
  SET 
    status = 'approved',
    tracking_number = p_tracking_number,
    approved_by = p_admin_id,
    updated_at = now()
  WHERE id = p_request_id
  RETURNING * INTO updated_request;
  
  -- ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
  IF updated_request IS NULL THEN
    RAISE EXCEPTION '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
  END IF;
  
  RETURN json_build_object(
    'success', true,
    'message', '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
    'data', row_to_json(updated_request)
  );
  
EXCEPTION
  WHEN OTHERS THEN
    RETURN json_build_object(
      'success', false,
      'error', SQLERRM
    );
END;
$$;
```

#### Step 2: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Frontend Code
```typescript
const handleApprove = async (trackingNumber: string) => {
  if (!request || !user?.id) return;
  
  try {
    // ‡πÉ‡∏ä‡πâ database function ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£ update ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
    const { data: result, error } = await supabase
      .rpc('approve_request', {
        p_request_id: request.id,
        p_tracking_number: trackingNumber,
        p_admin_id: user.id
      });
    
    if (error) {
      console.error('Supabase error:', error);
      toast.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏î‡πâ: ' + error.message);
      return;
    }
    
    // Type cast for result
    const typedResult = result as { success: boolean; error?: string; message?: string };
    
    if (!typedResult.success) {
      toast.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏î‡πâ: ' + typedResult.error);
      return;
    }
    
    // Force re-fetch to ensure UI updates
    await fetchRequest();
    
    toast.success('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
  } catch (error) {
    console.error('Error:', error);
    toast.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠');
  }
};
```

### ‡∏Ç‡πâ‡∏≠‡∏î‡∏µ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ SECURITY DEFINER Function
- **‡∏ú‡πà‡∏≤‡∏ô RLS Policy**: Function ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á function
- **‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢**: ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå admin ‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö database
- **‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô**: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á permission
- **‡∏á‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£ maintain**: logic ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô database ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÑ‡∏î‡πâ‡∏î‡∏µ

### ‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï

#### 1. ‡πÉ‡∏ä‡πâ Database Functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Critical Operations
```sql
-- ‡∏™‡∏£‡πâ‡∏≤‡∏á functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
CREATE OR REPLACE FUNCTION public.reject_request(...)
CREATE OR REPLACE FUNCTION public.request_rework(...)
CREATE OR REPLACE FUNCTION public.confirm_delivery(...)
```

#### 2. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö RLS Policies ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠
```javascript
// Test script ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö CRUD operations
const testCRUDOperations = async () => {
  // Test as admin
  // Test as requester  
  // Test as receiver
};
```

#### 3. Error Handling ‡∏ó‡∏µ‡πà‡∏î‡∏µ
```typescript
// Pattern ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö error handling
try {
  const { data, error } = await supabase.rpc('function_name', params);
  
  if (error) {
    console.error('Database error:', error);
    toast.error('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
    return;
  }
  
  const result = data as { success: boolean; error?: string };
  
  if (!result.success) {
    toast.error(result.error || '‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    return;
  }
  
  // Success handling
  toast.success('‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  await refetchData();
  
} catch (error) {
  console.error('Unexpected error:', error);
  toast.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏≤‡∏î‡∏Ñ‡∏¥‡∏î');
}
```

---

## Checklist ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤

- [ ] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö console logs
- [ ] ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
- [ ] ‡∏ó‡∏î‡∏™‡∏≠‡∏ö RLS policies
- [ ] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö user authentication state
- [ ] ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô component rendering logic
- [ ] ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö different user roles
- [ ] ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó documentation

---

**‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î**: 15 ‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏° 2568
**‡∏ú‡∏π‡πâ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó**: System Documentation